<!DOCTYPE html>
<html lang="en">
<head>
  <title>Whatsapp link</title>
  <script src="https://cdn.usefathom.com/script.js" data-site="KMHDNYSC" defer></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; font-size: x-large}
    button { background-color: red; color: white; border: none; border-radius: 5px; padding: 10px 20px; cursor: pointer; }
    h2 { margin-top: 20px; display: inline-block; }
    a {
      text-decoration: none;
      vertical-align: middle;
    }
    #goLink {
      background-color: green;
      padding: 10px;
      color: white;
      border-radius: 5px;
    }
    #phoneInput { border: 1px solid grey; border-radius: 5px; padding: 10px; font-size: 18px; }
    #phoneInput.invalid { border: 3px solid red; }
    #phoneInput.valid { border: 3px solid green; }
    #phoneInput:focus {
      outline: none;
      border: 1px solid grey;
    }

    #phoneInput.invalid:focus {
      outline: none;
      border: 3px solid red;
    }

    #phoneInput.valid:focus {
      border: 3px solid green;
    }

    #phoneList {
      list-style-type: none;
      padding-left: 0;
    }

    #phoneList li a {
      color: #007bff;
    }

    #phoneList li button {
      background-color: red; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; margin-left: 10px;
    }

    .visible { visibility: visible; }
    .hidden { visibility: hidden;}

  </style>
</head>
<body>
  <h2>Whatsapp link generator</h2>
  <br/>
  <input id="phoneInput" type="tel" class="input-box" required >
  <a id="goLink" href="#" class="hidden" >Open</a>

  <ul id="phoneList" ></ul>
  <button id="clearBtnList" class="hidden">Delete all</button>

   <script src="https://cdnjs.cloudflare.com/ajax/libs/libphonenumber-js/1.9.16/libphonenumber-js.min.js"></script>
   <script>
    const clearBtn = document.getElementById("clearBtnList");

    let countryCode = 'US'; // Default to US


    fetch('https://ipapi.co/country/')
    .then(response => response.text())
    .then(data => {
      countryCode = data;
    })
    .catch(error => {
      console.error('Error fetching country code:', error);
    });

    function build_url(phone) {
      return `whatsapp://send?phone=${phone}`
    }

    let phoneList = JSON.parse(localStorage.getItem("phoneList") || "[]");

    function updateList() {
      const ul = document.getElementById("phoneList");
      ul.innerHTML = "";
      for (const phone of phoneList) {
        const li = document.createElement("li");
        li.innerHTML = `<a href="${build_url(phone)}" target="_blank">${phone}</a>`;
        const delBtn = document.createElement("button");
        delBtn.innerText = "Delete";
        delBtn.addEventListener("click", function() {
          phoneList = phoneList.filter(p => p !== phone);
          localStorage.setItem("phoneList", JSON.stringify(phoneList));
          updateList();
        });
        li.appendChild(delBtn);
        ul.appendChild(li);
      }

      if (phoneList.length > 0) {
         clearBtn.classList.remove("hidden");
      } else {
         clearBtn.classList.add("hidden");
      }
    }

    function followAndStoreLink(phone) {
      if (!phoneList.includes(phone)) {
        phoneList.push(phone);
        localStorage.setItem("phoneList", JSON.stringify(phoneList));
        updateList();
      }
      window.open(build_url(phone));
    }

    const linkElem = document.getElementById("goLink");
    linkElem.addEventListener("click", function(e) {
          e.preventDefault();
          followAndStoreLink(phone);
          window.location.href = whatsappURL;
    });


    const inputElem = document.getElementById("phoneInput");
    inputElem.addEventListener("input", function(e) {
      const phone = e.target.value;
      const parsed = libphonenumber.parsePhoneNumberFromString(phone, countryCode);
      if (parsed && parsed.isValid()) {
        inputElem.classList.remove("invalid");
        inputElem.classList.add("valid");
        const phone = parsed.number;
        const whatsappURL = build_url(phone);
        linkElem.href = whatsappURL;
        linkElem.setAttribute('data-phone', phone)
        linkElem.classList.remove("hidden");
      } else {
        inputElem.classList.remove("valid");
        inputElem.classList.add("invalid");
        linkElem.classList.add("hidden");
        linkElem.setAttribute('data-phone', null)
      }
    });

    inputElem.addEventListener("keydown", function(e) {
      if (e.key === "Enter") {
        phone = linkElem.getAttribute("data-phone")
        if (phone) {
          followAndStoreLink(phone);
        }
      }
    });

    clearBtn.addEventListener("click", function() {
      phoneList = [];
      localStorage.setItem("phoneList", JSON.stringify(phoneList));
      updateList();
    });

    updateList();
  </script>
</body>
</html>
